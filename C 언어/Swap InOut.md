## Swap In/Out



메모리 스왑(swapping)은 물리적 메모리의 사용을 극대화하기 위한 메모리 회수 기법입니다. 메인 메모리의 프레임(frame)이 할당 되면 시스템은 더 이상 사용자 프로그램의 메모리 할당 요청을 처리 할 수 없게 됩니다. 이러한 상황에서 사용되지 않는 메모리 프레임을 디스크로 swap out 하여 일부 메모리 리소스를 해제하고 다른 애플리케이션에서 사용할 수 있도록 합니다.

스와핑은 운영 체제에 의해 수행됩니다. 시스템이 메모리 부족 상태인데도 메모리 할당 요청을 받으면, 운영 체제는 스왑 디스크로 내보낼 페이지를 선택합니다.

그런 다음, 메모리 프레임의 정확한 상태를 디스크로 복사합니다. 스왑아웃된 페이지에 접근하려는 프로세스가 있을 때, 운영 체제는 정확한 내용을 메모리로 다시 가져와서 페이지를 복구합니다.

eviction 대상으로 선택되는 페이지는 anonymous page 이거나 file-backed page 일 수 있습니다. 이 섹션에서는 각각의 경우를 처리할 것입니다. 모든 스왑 작업은 명식적으로 호출되지 않지만, 함수 포인터로 호출 됩니다. 이들은 struct page_operations file_ops 의 멤버이며, 각 페이지의 초기화 작업으로 등록 될것입니다.



### Anonymous Page

vm/anon.c 파일의 vm_anon_init 및 anon_initializer를 수정하세요. 익명 페이지는 백업 저장소를 갖고 있지 않습니다. 익명 페이지의 스왑을 지원하기 위해, 일시적인 백업 저장소로 스왑 디스크를 제공합니다.  스왑 디스크를 활용하여 익명 페이지의  스왑을 구현 할 것입니다.

```c
void vm_anon_init (void);
```

> 이 함수에서는 스왑디스크를 설정해야 합니다. 또한 스왑 디스크의 빈 영역과  사용 중인 영역을 관리하기 위한 데이터 구조가 필요합니다. 스왑 영역은 PGSIZE(4096 바이트)의 단위로 관리 될 것입니다. 



```c
bool anon_initializer (struct page *page, enum vm_type type, void *kva);
```

> 이것은 익명 페이지의 초기화입니다. 스왑을 지원하기 위해 anon_page에 몇 가지 정보를 추가해야 합니다. 



이제 anon_page의 스왑을 지원하기 위해 vm/anon.c에 anon_swap_in 과 anaon_swap_out을 구현하세요. 페이지를 스왑인하기 전에 스왑아웃해야 하므로,  anon_swap_in을 구현하기 전에 anon_swap_out을 구현하는 것이 좋습니다. 데이터 내용을 스왑 디스크로 이동시키고 안전하게 메모리로 다시 가져와야 합니다.

```c
static bool anon_swap_in (struct page *page, void *kva);
```

> anon_swap_in 함수는 스왑 디스크로 부터 데이터 내용을 읽어와 메모리로 익명 페이지를 스왑인 합니다. 페이지가 스왑아웃 될 때 페이지 구조체에 스왑 디스크 상의 데이터 위치가 저장 되어 있어야 합니다.  스왑 테이블을 업데이트 하는 것을 잊지 마세요.



```c
static bool anon_swap_out (struct page *page);
```

> anon_swap_out   함수는 메모리에서 스왑 디스크로 익명 페이지를 스왑아웃하여 내용을 복사합니다. 먼저, 스왑 테이블을 사용하여 디스크에서 빈 스왑 슬롯을 찾은 다음, 데이터 페이지를 해당 슬롯으로 복사합니다. 데이터의 위치는 페이지 구조체에 저장 되어야 합니다. 만약 디스크에 더 이상 빈 슬롯이 없다면, 커널을 패닉 상태로 전환 할 수 있습니다.



### File-Mapped Page

파일 지원 페이지의 내용은 파일에서 가져오므로, 백업 저장소로서 mmap 된 파일을 사용해야 합니다. 즉, 파일 지원 페이지를 추방 할 때는 해당 페이지를 매핑한 파일로 다시 기록합니다. 

vm/file.c에 file_backed_swap_in과 file_backed_swap_out을 구현하세요. 디자인에 따라 file_backed_init 및 file_initializer도 수정해야 할 수 있습니다.

```c
static bool file_backed_swap_in (struct page *page, void *kva);
```

> kva 에 있는 페이지를 스왑하여 파일에서 내용을 읽어 옵니다. 파일 시스템과 동기화해야 합니다.

 

```c
static bool file_backed_swap_out (struct page *page);
```

> 페이지를 스왑아웃하여 내용을 파일로 다시 기록합니다. 먼저 페이지가 변경되지 않은(clean) 상태인지 확인하는 것이 좋습니다. 변경되지 않은 경우, 파일의 내용을 수정할 필요가 없습니다. 페이지를 스왑아웃한 후에는  페이지의 dirty 비트를 해제하는 것을 잊지 마세요.