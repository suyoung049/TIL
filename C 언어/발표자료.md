커널 스레드 또는 사용자 프로세스입니다. 

- 각 스레드 구조체는 자체 4KB 페이지에 저장됩니다.
- 스레드 구조체 자체는 페이지의 맨 아래에 위치합니다.
- (오프셋 0에서). 나머지 페이지는 스레드의 커널 스택에 예약되며,
- 페이지의 맨 위에서 (4KB에서 offset) 아래로 확장됩니다.
- 이것은 다음과 같이 설명할 수 있습니다:



먼저, `struct thread`는 너무 커지면 안됩니다. 그렇게 되면 커널 스택에 충분한 공간이 없게 됩니다. 우리의 기본 `struct thread`는 몇 바이트 밖에 되지 않습니다. 크기는 아마도 1KB 미만으로 유지하는 것이 좋을 것입니다.

둘째로, 커널 스택도 너무 커지면 안됩니다. 스택이 오버플로되면 스레드 상태가 손상됩니다. 따라서 커널 함수는 비정적 로컬 변수로 큰 구조체나 배열을 할당해서는 안됩니다. 대신 malloc() 또는 palloc_get_page()을 사용하여 동적 할당을 해야합니다.

이러한 문제 중 하나의 첫 번째 증상은 대개 thread_current()에서 어설션(assertion) 실패가 될 것입니다. thread_current()는 실행 중인 스레드의 `struct thread`의 `magic` 멤버가 THREAD_MAGIC으로 설정되어 있는지 확인합니다. 스택 오버플로우는 이 값을 일반적으로 변경하여 어설션을 트리거합니다. */ /* `elem` 멤버는 이중 목적을 가지고 있습니다. 실행 대기열(thread.c)의 요소가 될 수도 있고, 세마포어 대기 목록(synch.c)의 요소가 될 수도 있습니다. 이 두 가지 방법으로만 사용할 수 있는 이유는 서로 상호배타적인 성격 때문입니다: 준비 상태(ready state)에있는 스레드만 실행 대기열에 있으며, 차단 상태(blocked state)에있는 스레드만 세마포어 대기 목록에 있습니다. */



1. error 발생(truble shootng)	

   thread_current()-> is_thread()  magic 넘버 집중

   앞으로의 project에서도 thread 구조체는 사용을 계속 하기 때문에 magic을 생각하면서 인자를 주어야 한다.

   페이지를 하나더 만드는게 전체적인 메모리상에는 손해가 될수 있지만 

   하나 더 말씀 드리면  thread에 magic 밑에 인자를 선언하면 안된다 입니다.  

   

네, 이 내용은 스레드 구조체와 관련이 있습니다. 스레드는 운영체제에서 실행 중인 프로세스의 작은 실행 단위입니다. 스레드 구조체는 스레드가 실행될 때 필요한 정보를 저장하는 데이터 구조입니다. 이 정보에는 스레드 ID, 우선 순위, 상태 등이 포함됩니다. 스레드 구조체는 4KB 페이지에 저장되며, 페이지의 맨 아래에 위치합니다. 스레드의 커널 스택은 페이지의 나머지 부분에 예약되며, 페이지의 맨 위에서 아래로 확장됩니다. 이렇게 구성된 스레드 구조체와 커널 스택은 스레드의 실행과 관련된 모든 정보를 저장하고 유지합니다. 따라서 위의 내용은 스레드 구조체와 커널 스택의 크기와 관련된 내용입니다.



스레드 구조체의 크기를 작게 만드는 방법은 여러 가지가 있을 수 있지만, 일반적으로는 다음과 같은 방법들이 사용됩니다.

1. 필요한 멤버 변수만 포함시키기: 스레드 구조체에 필요한 멤버 변수만을 포함시키면 구조체의 크기를 줄일 수 있습니다. 불필요한 변수를 제거하는 것이 중요합니다.
2. 포인터 사용하기: 스레드 구조체의 멤버 변수 대신 포인터를 사용하여 관련 정보를 저장할 수 있습니다. 예를 들어, 스레드의 이름을 저장하기 위해 문자열을 스레드 구조체에 저장하는 대신, 문자열을 동적으로 할당하고 스레드 구조체의 포인터로 저장할 수 있습니다.
3. 비트 필드 사용하기: 스레드 구조체의 멤버 변수 중 일부는 몇 개의 비트만 필요할 수 있습니다. 이 경우, 비트 필드를 사용하여 구조체의 크기를 줄일 수 있습니다.
4. 구조체 멤버 변수 순서 변경하기: 구조체 멤버 변수의 크기와 정렬에 따라 구조체의 크기가 달라질 수 있습니다. 이를 최적화하기 위해 구조체 멤버 변수의 순서를 변경할 수 있습니다.

이러한 방법을 조합하여 스레드 구조체의 크기를 최소화할 수 있습니다. 그러나 구조체의 크기를 줄이는 것보다는 스레드의 안정성과 기능을 보장하는 것이 우선되어야 합니다.



예상질문

`THREAD_MAGIC`은 스레드 구조체에 있는 magic 멤버의 값으로, 스레드 구조체의 유효성을 검사하기 위해 사용됩니다. 즉, `thread_current()` 함수에서 실행 중인 스레드의 `magic` 멤버가 `THREAD_MAGIC`으로 설정되어 있는지 확인하여 스택 오버플로우 등의 문제가 발생하지 않았는지 확인합니다.

`THREAD_MAGIC` 값은 임의로 지정할 수 있으며, 일반적으로 특정한 값으로 정의됩니다. 예를 들어, Pintos OS에서는 `0xcd6abf4b` 값을 `THREAD_MAGIC`으로 사용합니다. 이 값은 임의로 선택된 것으로 보이며, 애플리케이션 레벨에서 사용하지 않는 값이기 때문에 충돌할 가능성이 상대적으로 적다고 판단되는 값으로 선택된 것으로 추측됩니다.

`struct thread` 안에 새로운 변수를 추가하면 `thread_current()` 함수에서 호출하는 `is_thread()` 함수에서 오류가 발생할 수 있습니다. 이 함수는 현재 실행중인 스레드의 `magic` 멤버를 확인하여 잘못된 포인터 참조를 방지하기 위한 보호장치 역할을 합니다. 따라서 `struct thread`에 새로운 멤버를 추가할 때는 해당 멤버 이후에 `magic` 멤버가 위치하도록 해야합니다. 그렇지 않으면 `magic` 멤버를 잘못 인식하여 오류가 발생할 수 있습니다. 또한 새로운 멤버가 스레드 구조체의 크기를 증가시켜서 메모리를 많이 차지하게 될 경우 스택 오버플로우 등의 문제가 발생할 수 있으므로 주의해야 합니다.

